<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ÄÄƒng kÃ½ má»Ÿ lá»›p - GiÃ¡o viÃªn</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/dashboard.css">
  <style>
    .grid {display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:14px}
    @media (max-width: 900px){ .grid {grid-template-columns: 1fr} }
    .card h3 {margin:0 0 8px}
    .muted {font-size:12px;color:#64748b}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-outline{background:transparent;border:1px solid #cbd5e1;color:#334155}
    .btn-group{display:flex;gap:8px;justify-content:flex-end}
    .badge-approved{background:#dcfce7;color:#166534;padding:.25rem .5rem;border-radius:999px}
    .badge-pending{background:#dbeafe;color:#1e3a8a;padding:.25rem .5rem;border-radius:999px}
    .badge-rejected{background:#fee2e2;color:#991b1b;padding:.25rem .5rem;border-radius:999px}
    td.actions{text-align:right}
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <h3>TMS</h3>
          <div class="small-muted">GiÃ¡o viÃªn</div>
        </div>
      </div>
      <nav class="nav">
        <a href="dashboard_teacher.html">ğŸ  Trang chá»§</a>
        <a href="register-subject_teacher.html">ğŸ“š ÄÄƒng kÃ½ mÃ´n</a>
        <a href="register-class_teacher_new.html" class="active">ğŸ—‚ï¸ ÄÄƒng kÃ½ má»Ÿ lá»›p</a>
        <a href="report_teacher.html">ğŸ“„ BÃ¡o cÃ¡o</a>
        <a href="profile_teacher.html">ğŸ‘¤ Há»“ sÆ¡</a>
        <a href="login.html" id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</a>
      </nav>
    </aside>

    <main class="main">
      <div class="header-row">
        <div>
          <div class="h1">ÄÄƒng kÃ½ má»Ÿ lá»›p</div>
          <div class="small-muted">Nháº­p thÃ´ng tin lá»›p muá»‘n má»Ÿ vÃ  gá»­i admin duyá»‡t</div>
        </div>
      </div>

      <!-- FORM ÄÄ‚NG KÃ -->
      <div class="card" style="max-width:980px">
        <h3>ThÃ´ng tin lá»›p Ä‘á» nghá»‹</h3>
        <div class="grid">
          <div>
            <label class="small-muted">TÃªn lá»›p <span style="color:#ef4444">*</span></label>
            <input id="inpName" class="input" placeholder="VD: ToÃ¡n 12 - Luyá»‡n thi THPT" required>
          </div>

          <div>
            <label class="small-muted">MÃ´n há»c <span style="color:#ef4444">*</span></label>
            <select id="selSubject" class="input"></select>
          </div>

          <div>
            <label class="small-muted">SÄ© sá»‘ tá»‘i Ä‘a</label>
            <input id="inpCapacity" class="input" type="number" min="1" placeholder="VD: 30">
          </div>

          <div>
            <label class="small-muted">HÃ¬nh thá»©c</label>
            <select id="selMode" class="input">
              <option value="Trong trÆ°á»ng">Trong trÆ°á»ng</option>
              <option value="NgoÃ i trÆ°á»ng">NgoÃ i trÆ°á»ng</option>
              <option value="Online">Online</option>
            </select>
          </div>

          <div>
            <label class="small-muted">NgÃ y báº¯t Ä‘áº§u (tuá»³ chá»n)</label>
            <input id="inpStartDate" class="input" type="date">
          </div>

          <div>
            <label class="small-muted">Äá»‹a Ä‘iá»ƒm (náº¿u cÃ³)</label>
            <input id="inpLocation" class="input" placeholder="VD: P.302 - CÆ¡ sá»Ÿ A">
          </div>

          <div style="grid-column:1/-1">
            <label class="small-muted">Lá»‹ch há»c (tá»± do) <span style="color:#ef4444">*</span></label>
            <input id="inpSchedule" class="input" placeholder="VD: T2, T5 (19:00 - 21:00)">
          </div>

          <div style="grid-column:1/-1">
            <label class="small-muted">Há»c phÃ­ / ghi chÃº</label>
            <textarea id="inpNote" class="input" rows="3" placeholder="VD: 800k/thÃ¡ng. Ghi chÃº thÃªm..."></textarea>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnSubmit" class="btn btn-primary">Gá»­i Ä‘Äƒng kÃ½</button>
          <button id="btnReset" class="btn btn-outline" type="button">LÃ m má»›i</button>
        </div>
      </div>

      <!-- DANH SÃCH YÃŠU Cáº¦U Cá»¦A TÃ”I -->
      <div class="card" style="margin-top:16px">
        <div class="h2" style="margin:0 0 8px">YÃªu cáº§u tÃ´i Ä‘Ã£ gá»­i</div>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>TÃªn lá»›p</th>
              <th>MÃ´n</th>
              <th>SÄ© sá»‘</th>
              <th>Lá»‹ch há»c</th>
              <th>Tráº¡ng thÃ¡i</th>
              <th style="width:180px;text-align:right">HÃ nh Ä‘á»™ng</th>
            </tr>
          </thead>
          <tbody id="tbodyMyReqs">
            <tr><td colspan="7">Äang táº£i...</td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="assets/js/api.js"></script>
  <script>
    // ==== API endpoints ====
    const API_SUBJECTS   = '/api/subjects';                            // GET
    const API_MY_REQS    = '/api/teacher/registrations';               // GET (tráº£ DTO theo pháº§n BE bÃªn dÆ°á»›i)
    const API_CREATE_CUS = '/api/teacher/registrations/custom';               // POST (1 endpoint há»£p nháº¥t: classId hoáº·c custom)
    const API_DELETE     = (id) => `/api/teacher/registrations/${id}`; // DELETE (há»§y khi PENDING)

    // ===== SUBJECT CACHE =====
    let SUBJECTS = [];
    let SUBJECT_NAME_BY_ID = {};

    document.addEventListener('DOMContentLoaded', init);

    async function init(){
      if (!requireLoginOrRedirect()) return;
      if (!requireRoleOrRedirect('TEACHER')) return;
      wireLogout('logoutBtn');

      await loadSubjects();          // Ä‘á»• select + táº¡o map
      await loadMyRequests();

      document.getElementById('btnSubmit').addEventListener('click', submitForm);
      document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('inpName').value='';
        document.getElementById('inpCapacity').value='';
        document.getElementById('inpStartDate').value='';
        document.getElementById('inpLocation').value='';
        document.getElementById('inpSchedule').value='';
        document.getElementById('inpNote').value='';
        document.getElementById('selSubject').value='';
        document.getElementById('selMode').value='Trong trÆ°á»ng';
      });

      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-act]');
        if(!btn) return;
        if (btn.dataset.act === 'cancel') {
          const id = +btn.dataset.id;
          if (confirm('Há»§y yÃªu cáº§u nÃ y?')) {
            try {
              await fetchJSON(API_DELETE(id), { method:'DELETE' });
              await loadMyRequests();
            } catch (err) {
              alert(err.message || 'KhÃ´ng thá»ƒ há»§y yÃªu cáº§u');
            }
          }
        }
      });
    }

    async function loadSubjects(){
      const sel = document.getElementById('selSubject');
      sel.innerHTML = `<option value="">Äang táº£i...</option>`;
      try {
        const data = await fetchJSON(API_SUBJECTS);
        const arr = Array.isArray(data) ? data : (data?.content || []);
        SUBJECTS = arr;
        SUBJECT_NAME_BY_ID = {};
        sel.innerHTML = `<option value="">-- Chá»n mÃ´n --</option>` + 
          arr.map(s => {
            SUBJECT_NAME_BY_ID[Number(s.id)] = s.name || s.subjectName || ('MÃ´n ' + s.id);
            return `<option value="${s.id}">${s.code || ''} - ${s.name || ''} ${s.grade?('('+s.grade+')'):''}</option>`;
          }).join('');
      } catch (e) {
        sel.innerHTML = `<option value="">(Lá»—i táº£i danh sÃ¡ch mÃ´n)</option>`;
        console.error(e);
      }
    }

    function buildPayload(){
      return {
        classId:    null, // náº¿u muá»‘n Ä‘Äƒng kÃ½ vÃ o lá»›p cÃ³ sáºµn, set sá»‘ id á»Ÿ Ä‘Ã¢y
        className:  document.getElementById('inpName').value.trim(),
        subjectId:  +document.getElementById('selSubject').value || null,
        capacity:   toNum(document.getElementById('inpCapacity').value),
        mode:       document.getElementById('selMode').value,
        startDate:  document.getElementById('inpStartDate').value || null,
        location:   document.getElementById('inpLocation').value.trim(),
        schedule:   document.getElementById('inpSchedule').value.trim(),
        note:       document.getElementById('inpNote').value.trim()
      };
      function toNum(v){ const n = Number(v); return Number.isFinite(n) && n>0 ? n : null; }
    }

    async function submitForm(){
      const payload = buildPayload();

      // Validate nhanh
      if (!payload.className) return alert('Vui lÃ²ng nháº­p TÃªn lá»›p');
      if (!payload.subjectId) return alert('Vui lÃ²ng chá»n MÃ´n há»c');
      if (!payload.schedule)  return alert('Vui lÃ²ng nháº­p Lá»‹ch há»c');

      try{
        // 1 endpoint há»£p nháº¥t: cÃ³ classId -> vÃ o lá»›p cÃ³ sáºµn; null -> custom
        await fetchJSON(API_CREATE_CUS, { method:'POST', body: JSON.stringify(payload) });
        alert('ÄÃ£ gá»­i Ä‘Äƒng kÃ½ má»Ÿ lá»›p. Vui lÃ²ng chá» admin duyá»‡t.');
        await loadMyRequests();
      }catch(e){
        console.error(e);
        alert(e.message || 'KhÃ´ng thá»ƒ gá»­i Ä‘Äƒng kÃ½');
      }
    }

    function subjectNameOf(r) {
      // Æ¯u tiÃªn DTO tá»« BE
      if (r?.subjectName) return r.subjectName;
      // Náº¿u BE váº«n tráº£ entity thay vÃ¬ DTO
      if (r?.subject?.name) return r.subject.name;
      if (r?.teachingClass?.subject?.name) return r.teachingClass.subject.name;
      // Fallback theo id
      const sid = r?.subjectId ?? r?.subject?.id ?? r?.teachingClass?.subject?.id;
      if (sid != null && SUBJECT_NAME_BY_ID[Number(sid)]) return SUBJECT_NAME_BY_ID[Number(sid)];
      return '-';
    }

    async function loadMyRequests(){
      const tbody = document.getElementById('tbodyMyReqs');
      tbody.innerHTML = `<tr><td colspan="7">Äang táº£i...</td></tr>`;
      try{
        const list = await fetchJSON(API_MY_REQS);
        const arr = Array.isArray(list) ? list : (list?.content || []);
        const rows = arr.map(r => {
          const name = r.teachingClassName || r.teachingClass?.name || r.className || '-';
          const subjectName = subjectNameOf(r);
          const capacity = r.teachingClass?.capacity ?? r.capacity ?? '-';
          const schedule = r.schedule || r.teachingClass?.scheduleText || '-';
          const status = (r.status || 'PENDING').toUpperCase();

          let badge = `<span class="badge-pending">Chá» duyá»‡t</span>`;
          if (status === 'APPROVED') badge = `<span class="badge-approved">ÄÃ£ duyá»‡t</span>`;
          if (status === 'REJECTED') badge = `<span class="badge-rejected">Bá»‹ tá»« chá»‘i</span>`;

          let actions = `<div class="btn-group"><button class="btn btn-outline" disabled>KhÃ´ng thao tÃ¡c</button></div>`;
          if (status === 'PENDING') {
            actions = `
              <div class="btn-group">
                <button class="btn btn-danger" data-act="cancel" data-id="${r.id}">Há»§y yÃªu cáº§u</button>
              </div>`;
          }

          return `
            <tr>
              <td>${r.id}</td>
              <td>${escapeHtml(name)}</td>
              <td>${escapeHtml(subjectName)}</td>
              <td>${capacity}</td>
              <td>${escapeHtml(schedule)}</td>
              <td>${badge}</td>
              <td class="actions">${actions}</td>
            </tr>`;
        }).join('');

        tbody.innerHTML = rows || `<tr><td colspan="7">ChÆ°a cÃ³ yÃªu cáº§u nÃ o</td></tr>`;
      }catch(e){
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="7">Lá»—i táº£i dá»¯ liá»‡u</td></tr>`;
      }
    }

    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  </script>
</body>
</html>
