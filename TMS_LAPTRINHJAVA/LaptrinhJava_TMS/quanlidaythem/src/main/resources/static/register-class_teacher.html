<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ƒêƒÉng k√Ω m·ªü l·ªõp - Gi√°o vi√™n</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/dashboard.css">
  <style>
    .grid {display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:14px}
    @media (max-width: 900px){ .grid {grid-template-columns: 1fr} }
    .card h3 {margin:0 0 8px}
    .muted {font-size:12px;color:#64748b}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-outline{background:transparent;border:1px solid #cbd5e1;color:#334155}
    .btn-group{display:flex;gap:8px;justify-content:flex-end}
    .badge-approved{background:#dcfce7;color:#166534;padding:.25rem .5rem;border-radius:999px}
    .badge-pending{background:#dbeafe;color:#1e3a8a;padding:.25rem .5rem;border-radius:999px}
    .badge-rejected{background:#fee2e2;color:#991b1b;padding:.25rem .5rem;border-radius:999px}
    td.actions{text-align:right}
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <h3>TMS</h3>
          <div class="small-muted">Gi√°o vi√™n</div>
        </div>
      </div>
      <nav class="nav">
        <a href="dashboard_teacher.html">üè† Trang ch·ªß</a>
        <a href="register-class_teacher.html" class="active">üóÇÔ∏è ƒêƒÉng k√Ω m·ªü l·ªõp</a>
        <a href="report_teacher.html">üìÑ B√°o c√°o</a>
        <a href="profile_teacher.html">üë§ H·ªì s∆°</a>
        <a href="login.html" id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</a>
      </nav>
    </aside>

    <main class="main">
      <div class="header-row">
        <div>
          <div class="h1">ƒêƒÉng k√Ω m·ªü l·ªõp</div>
          <div class="small-muted">Nh·∫≠p th√¥ng tin l·ªõp mu·ªën m·ªü v√† g·ª≠i admin duy·ªát</div>
        </div>
      </div>

      <!-- FORM ƒêƒÇNG K√ù -->
      <div class="card" style="max-width:980px">
        <h3>Th√¥ng tin l·ªõp ƒë·ªÅ ngh·ªã</h3>
        <div class="grid">
          <div>
            <label class="small-muted">T√™n l·ªõp <span style="color:#ef4444">*</span></label>
            <input id="inpName" class="input" placeholder="VD: To√°n 12 - Luy·ªán thi THPT" required>
          </div>

          <div>
            <label class="small-muted">M√¥n h·ªçc <span style="color:#ef4444">*</span></label>
            <select id="selSubject" class="input"></select>
          </div>

          <div>
            <label class="small-muted">Sƒ© s·ªë t·ªëi ƒëa</label>
            <input id="inpCapacity" class="input" type="number" min="1" placeholder="VD: 30">
          </div>

          <div>
            <label class="small-muted">H√¨nh th·ª©c</label>
            <select id="selMode" class="input">
              <option value="Trong tr∆∞·ªùng">Trong tr∆∞·ªùng</option>
              <option value="Ngo√†i tr∆∞·ªùng">Ngo√†i tr∆∞·ªùng</option>
              <option value="Online">Online</option>
            </select>
          </div>

          <div>
            <label class="small-muted">Ng√†y b·∫Øt ƒë·∫ßu (tu·ª≥ ch·ªçn)</label>
            <input id="inpStartDate" class="input" type="date">
          </div>

          <div>
            <label class="small-muted">ƒê·ªãa ƒëi·ªÉm (n·∫øu c√≥)</label>
            <input id="inpLocation" class="input" placeholder="VD: P.302 - C∆° s·ªü A">
          </div>

          <div style="grid-column:1/-1">
            <label class="small-muted">L·ªãch h·ªçc (t·ª± do) <span style="color:#ef4444">*</span></label>
            <input id="inpSchedule" class="input" placeholder="VD: T2, T5 (19:00 - 21:00)">
          </div>

          <div style="grid-column:1/-1">
            <label class="small-muted">H·ªçc ph√≠ / ghi ch√∫</label>
            <textarea id="inpNote" class="input" rows="3" placeholder="VD: 800k/th√°ng. Ghi ch√∫ th√™m..."></textarea>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnSubmit" class="btn btn-primary">G·ª≠i ƒëƒÉng k√Ω</button>
          <button id="btnReset" class="btn btn-outline" type="button">L√†m m·ªõi</button>
        </div>
      </div>

      <!-- DANH S√ÅCH Y√äU C·∫¶U C·ª¶A T√îI -->
      <div class="card" style="margin-top:16px">
        <div class="h2" style="margin:0 0 8px">Y√™u c·∫ßu t√¥i ƒë√£ g·ª≠i</div>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>T√™n l·ªõp</th>
              <th>M√¥n</th>
              <th>Sƒ© s·ªë</th>
              <th>L·ªãch h·ªçc</th>
              <th>Tr·∫°ng th√°i</th>
              <th style="width:180px;text-align:right">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="tbodyMyReqs">
            <tr><td colspan="7">ƒêang t·∫£i...</td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="/assets/js/tms-api.js"></script>
  <script src="/assets/js/auth.js"></script>
  <script src="/assets/js/rbac.js"></script>

  <script>
    // ==== API endpoints ====
    const API_SUBJECTS   = '/api/subjects';                            // GET
    const API_MY_REQS    = '/api/teacher/registrations';               // GET (tr·∫£ DTO theo ph·∫ßn BE b√™n d∆∞·ªõi)
    const API_CREATE_CUS = '/api/teacher/registrations/custom';               // POST (1 endpoint h·ª£p nh·∫•t: classId ho·∫∑c custom)
    const API_DELETE     = (id) => `/api/teacher/registrations/${id}`; // DELETE (h·ªßy khi PENDING)

    // ===== SUBJECT CACHE =====
    let SUBJECTS = [];
    let SUBJECT_NAME_BY_ID = {};

    document.addEventListener('DOMContentLoaded', init);

    async function init(){
      if (!requireLoginOrRedirect()) return;
      if (!requireRoleOrRedirect('TEACHER')) return;
      wireLogout('logoutBtn');

      await loadSubjects();          // ƒë·ªï select + t·∫°o map
      await loadMyRequests();

      document.getElementById('btnSubmit').addEventListener('click', submitForm);
      document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('inpName').value='';
        document.getElementById('inpCapacity').value='';
        document.getElementById('inpStartDate').value='';
        document.getElementById('inpLocation').value='';
        document.getElementById('inpSchedule').value='';
        document.getElementById('inpNote').value='';
        document.getElementById('selSubject').value='';
        document.getElementById('selMode').value='Trong tr∆∞·ªùng';
      });

      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-act]');
        if(!btn) return;
        if (btn.dataset.act === 'cancel') {
          const id = +btn.dataset.id;
          if (confirm('H·ªßy y√™u c·∫ßu n√†y?')) {
            try {
              await fetchJSON(API_DELETE(id), { method:'DELETE' });
              await loadMyRequests();
            } catch (err) {
              alert(err.message || 'Kh√¥ng th·ªÉ h·ªßy y√™u c·∫ßu');
            }
          }
        }
      });
    }

    // Danh s√°ch t·∫•t c·∫£ c√°c m√¥n h·ªçc (hardcoded gi·ªëng trang admin)
    const ALL_SUBJECTS = [
      { key: 'math', label: 'To√°n h·ªçc' },
      { key: 'physics', label: 'V·∫≠t l√Ω' },
      { key: 'chemistry', label: 'H√≥a h·ªçc' },
      { key: 'english', label: 'Ti·∫øng Anh' },
      { key: 'biology', label: 'Sinh h·ªçc' },
      { key: 'literature', label: 'Ng·ªØ vƒÉn' },
      { key: 'history', label: 'L·ªãch s·ª≠' },
      { key: 'geography', label: 'ƒê·ªãa l√Ω' },
      { key: 'information technology', label: 'Tin H·ªçc' }
    ];

    // Map subject key -> subjectId (t·ª´ database)
    const SUBJECT_KEY_TO_ID = {};

    async function loadSubjects(){
      const sel = document.getElementById('selSubject');
      sel.innerHTML = `<option value="">ƒêang t·∫£i...</option>`;
      try {
        // Load subjects t·ª´ API ƒë·ªÉ map key -> id
        const data = await fetchJSON(API_SUBJECTS);
        const arr = Array.isArray(data) ? data : (data?.content || []);
        SUBJECTS = arr;
        SUBJECT_NAME_BY_ID = {};
        SUBJECT_KEY_TO_ID = {}; // Reset map
        
        // T·∫°o map subject code/key -> subjectId
        for (const s of arr) {
          if (s.id) {
            SUBJECT_NAME_BY_ID[Number(s.id)] = s.name || s.subjectName || ('M√¥n ' + s.id);
            const codeLower = (s.code || '').toLowerCase();
            const nameLower = (s.name || '').toLowerCase();
            
            if (codeLower || nameLower) {
              // Match v·ªõi subject key b·∫±ng nhi·ªÅu c√°ch
              for (const subj of ALL_SUBJECTS) {
                // Match theo code: "TOAN12", "TOAN", "math" -> "math"
                if (codeLower) {
                  if (codeLower === subj.key || 
                      codeLower.includes(subj.key) || 
                      subj.key.includes(codeLower)) {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                  // Match c√°c bi·∫øn th·ªÉ code: TOAN, TOAN12, TOANHOC -> math
                  if (codeLower.includes('toan') && subj.key === 'math') {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                  if (codeLower.includes('ly') && subj.key === 'physics') {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                  if (codeLower.includes('hoa') && subj.key === 'chemistry') {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                  if (codeLower.includes('anh') && subj.key === 'english') {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                  if (codeLower.includes('sinh') && subj.key === 'biology') {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                  if (codeLower.includes('van') && subj.key === 'literature') {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                  if (codeLower.includes('su') && subj.key === 'history') {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                  if (codeLower.includes('dia') && subj.key === 'geography') {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                  if ((codeLower.includes('tin') || codeLower.includes('it')) && subj.key === 'information technology') {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                }
                
                // Match theo name: "To√°n h·ªçc", "To√°n", "To√°n 12" -> "math"
                if (nameLower) {
                  const labelLower = subj.label.toLowerCase();
                  // Match ch√≠nh x√°c ho·∫∑c ch·ª©a t·ª´ kh√≥a ch√≠nh
                  if (nameLower === labelLower || 
                      nameLower.includes(labelLower) || 
                      labelLower.includes(nameLower) ||
                      // Match c√°c t·ª´ kh√≥a: "to√°n" trong "to√°n h·ªçc", "to√°n 12", etc.
                      (nameLower.includes('to√°n') && subj.key === 'math') ||
                      (nameLower.includes('v·∫≠t l√Ω') && subj.key === 'physics') ||
                      (nameLower.includes('h√≥a h·ªçc') && subj.key === 'chemistry') ||
                      (nameLower.includes('ti·∫øng anh') && subj.key === 'english') ||
                      (nameLower.includes('sinh h·ªçc') && subj.key === 'biology') ||
                      (nameLower.includes('ng·ªØ vƒÉn') && subj.key === 'literature') ||
                      (nameLower.includes('l·ªãch s·ª≠') && subj.key === 'history') ||
                      (nameLower.includes('ƒë·ªãa l√Ω') && subj.key === 'geography') ||
                      ((nameLower.includes('tin h·ªçc') || nameLower.includes('tin')) && subj.key === 'information technology')) {
                    SUBJECT_KEY_TO_ID[subj.key] = Number(s.id);
                  }
                }
              }
              
              // L∆∞u theo code g·ªëc n·∫øu ch∆∞a c√≥
              if (codeLower && !SUBJECT_KEY_TO_ID[codeLower]) {
                SUBJECT_KEY_TO_ID[codeLower] = Number(s.id);
              }
            }
          }
        }

        // T·∫°o dropdown v·ªõi t·∫•t c·∫£ c√°c m√¥n (hardcoded gi·ªëng admin)
        sel.innerHTML = `<option value="">-- Ch·ªçn m√¥n --</option>` + 
          ALL_SUBJECTS.map(subj => {
            const subjectId = SUBJECT_KEY_TO_ID[subj.key] || '';
            // L∆∞u mapping trong data attribute
            return `<option value="${subj.key}" data-subject-id="${subjectId}">${subj.label}</option>`;
          }).join('');
        
        // Debug: log mapping ƒë·ªÉ ki·ªÉm tra
        console.log('Subject mapping:', SUBJECT_KEY_TO_ID);
      } catch (e) {
        console.error('Load subjects error:', e);
        // Fallback: v·∫´n hi·ªÉn th·ªã hardcoded list n·∫øu API l·ªói
        sel.innerHTML = `<option value="">-- Ch·ªçn m√¥n --</option>` + 
          ALL_SUBJECTS.map(subj => 
            `<option value="${subj.key}" data-subject-id="">${subj.label}</option>`
          ).join('');
      }
    }

    function buildPayload(){
      const selSubject = document.getElementById('selSubject');
      const selectedOption = selSubject.options[selSubject.selectedIndex];
      const subjectKey = selSubject.value;
      
      if (!subjectKey) {
        return {
          classId: null,
          className: document.getElementById('inpName').value.trim(),
          subjectId: null,
          capacity: toNum(document.getElementById('inpCapacity').value),
          mode: document.getElementById('selMode').value,
          startDate: document.getElementById('inpStartDate').value || null,
          location: document.getElementById('inpLocation').value.trim() || null,
          schedule: document.getElementById('inpSchedule').value.trim() || null,
          note: document.getElementById('inpNote').value.trim() || null
        };
      }
      
      // L·∫•y subjectId t·ª´ data attribute (∆∞u ti√™n)
      let subjectId = null;
      if (selectedOption) {
        const dataId = selectedOption.getAttribute('data-subject-id');
        if (dataId && dataId !== '') {
          subjectId = Number(dataId);
        }
      }
      
      // N·∫øu kh√¥ng c√≥ t·ª´ data attribute, th·ª≠ l·∫•y t·ª´ SUBJECT_KEY_TO_ID
      if (!subjectId && subjectKey) {
        subjectId = SUBJECT_KEY_TO_ID[subjectKey] || null;
      }
      
      // N·∫øu v·∫´n kh√¥ng c√≥, th·ª≠ t√¨m trong SUBJECTS b·∫±ng key
      if (!subjectId && subjectKey) {
        // T√¨m subject c√≥ name/code match v·ªõi subjectKey
        for (const s of SUBJECTS) {
          const codeLower = (s.code || '').toLowerCase();
          const nameLower = (s.name || '').toLowerCase();
          const keyLower = subjectKey.toLowerCase();
          
          // Match tr·ª±c ti·∫øp
          if (codeLower === keyLower || nameLower === keyLower) {
            subjectId = Number(s.id);
            break;
          }
          
          // Match theo t·ª´ kh√≥a
          if (keyLower === 'math' && (codeLower.includes('toan') || nameLower.includes('to√°n'))) {
            subjectId = Number(s.id);
            break;
          }
          if (keyLower === 'physics' && (codeLower.includes('ly') || nameLower.includes('v·∫≠t l√Ω'))) {
            subjectId = Number(s.id);
            break;
          }
          if (keyLower === 'chemistry' && (codeLower.includes('hoa') || nameLower.includes('h√≥a h·ªçc'))) {
            subjectId = Number(s.id);
            break;
          }
          if (keyLower === 'english' && (codeLower.includes('anh') || nameLower.includes('ti·∫øng anh'))) {
            subjectId = Number(s.id);
            break;
          }
          if (keyLower === 'biology' && (codeLower.includes('sinh') || nameLower.includes('sinh h·ªçc'))) {
            subjectId = Number(s.id);
            break;
          }
          if (keyLower === 'literature' && (codeLower.includes('van') || nameLower.includes('ng·ªØ vƒÉn'))) {
            subjectId = Number(s.id);
            break;
          }
          if (keyLower === 'history' && (codeLower.includes('su') || nameLower.includes('l·ªãch s·ª≠'))) {
            subjectId = Number(s.id);
            break;
          }
          if (keyLower === 'geography' && (codeLower.includes('dia') || nameLower.includes('ƒë·ªãa l√Ω'))) {
            subjectId = Number(s.id);
            break;
          }
          if (keyLower === 'information technology' && (codeLower.includes('tin') || nameLower.includes('tin h·ªçc'))) {
            subjectId = Number(s.id);
            break;
          }
        }
      }
      
      console.log('Selected subject key:', subjectKey, '-> subjectId:', subjectId);
      
      return {
        classId:    null, // n·∫øu mu·ªën ƒëƒÉng k√Ω v√†o l·ªõp c√≥ s·∫µn, set s·ªë id ·ªü ƒë√¢y
        className:  document.getElementById('inpName').value.trim(),
        subjectId:  subjectId ? Number(subjectId) : null,
        capacity:   toNum(document.getElementById('inpCapacity').value),
        mode:       document.getElementById('selMode').value,
        startDate:  document.getElementById('inpStartDate').value || null,
        location:   document.getElementById('inpLocation').value.trim() || null,
        schedule:   document.getElementById('inpSchedule').value.trim() || null,
        note:       document.getElementById('inpNote').value.trim() || null
      };
    }
    
    function toNum(v){ const n = Number(v); return Number.isFinite(n) && n>0 ? n : null; }

    async function submitForm(){
      const payload = buildPayload();

      // Validate nhanh
      if (!payload.className) return alert('Vui l√≤ng nh·∫≠p T√™n l·ªõp');
      const selSubject = document.getElementById('selSubject');
      const subjectKey = selSubject.value;
      if (!subjectKey) return alert('Vui l√≤ng ch·ªçn M√¥n h·ªçc');
      if (!payload.subjectId) {
        const selectedLabel = selSubject.options[selSubject.selectedIndex]?.text || subjectKey;
        return alert(`Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc "${selectedLabel}" trong h·ªá th·ªëng. Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ th√™m m√¥n h·ªçc n√†y.`);
      }
      if (!payload.schedule)  return alert('Vui l√≤ng nh·∫≠p L·ªãch h·ªçc');

      try{
        // 1 endpoint h·ª£p nh·∫•t: c√≥ classId -> v√†o l·ªõp c√≥ s·∫µn; null -> custom
        await fetchJSON(API_CREATE_CUS, { method:'POST', body: JSON.stringify(payload) });
        alert('ƒê√£ g·ª≠i ƒëƒÉng k√Ω m·ªü l·ªõp. Vui l√≤ng ch·ªù admin duy·ªát.');
        await loadMyRequests();
      }catch(e){
        console.error(e);
        alert(e.message || 'Kh√¥ng th·ªÉ g·ª≠i ƒëƒÉng k√Ω');
      }
    }

    function subjectNameOf(r) {
      // ∆Øu ti√™n DTO t·ª´ BE
      if (r?.subjectName) return r.subjectName;
      // N·∫øu BE v·∫´n tr·∫£ entity thay v√¨ DTO
      if (r?.subject?.name) return r.subject.name;
      if (r?.teachingClass?.subject?.name) return r.teachingClass.subject.name;
      // Fallback theo id
      const sid = r?.subjectId ?? r?.subject?.id ?? r?.teachingClass?.subject?.id;
      if (sid != null && SUBJECT_NAME_BY_ID[Number(sid)]) return SUBJECT_NAME_BY_ID[Number(sid)];
      return '-';
    }

    async function loadMyRequests(){
      const tbody = document.getElementById('tbodyMyReqs');
      tbody.innerHTML = `<tr><td colspan="7">ƒêang t·∫£i...</td></tr>`;
      try{
        const list = await fetchJSON(API_MY_REQS);
        const arr = Array.isArray(list) ? list : (list?.content || []);
        const rows = arr.map(r => {
          const name = r.teachingClassName || r.teachingClass?.name || r.className || '-';
          const subjectName = subjectNameOf(r);
          const capacity = r.teachingClass?.capacity ?? r.capacity ?? '-';
          const schedule = r.schedule || r.teachingClass?.scheduleText || '-';
          const status = (r.status || 'PENDING').toUpperCase();

          let badge = `<span class="badge-pending">Ch·ªù duy·ªát</span>`;
          if (status === 'APPROVED') badge = `<span class="badge-approved">ƒê√£ duy·ªát</span>`;
          if (status === 'REJECTED') badge = `<span class="badge-rejected">B·ªã t·ª´ ch·ªëi</span>`;

          let actions = `<div class="btn-group"><button class="btn btn-outline" disabled>Kh√¥ng thao t√°c</button></div>`;
          if (status === 'PENDING') {
            actions = `
              <div class="btn-group">
                <button class="btn btn-danger" data-act="cancel" data-id="${r.id}">H·ªßy y√™u c·∫ßu</button>
              </div>`;
          }

          return `
            <tr>
              <td>${r.id}</td>
              <td>${escapeHtml(name)}</td>
              <td>${escapeHtml(subjectName)}</td>
              <td>${capacity}</td>
              <td>${escapeHtml(schedule)}</td>
              <td>${badge}</td>
              <td class="actions">${actions}</td>
            </tr>`;
        }).join('');

        tbody.innerHTML = rows || `<tr><td colspan="7">Ch∆∞a c√≥ y√™u c·∫ßu n√†o</td></tr>`;
      }catch(e){
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="7">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`;
      }
    }

    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  </script>
</body>
</html>
