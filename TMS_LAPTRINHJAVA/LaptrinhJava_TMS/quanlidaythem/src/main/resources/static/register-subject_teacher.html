<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÄÄƒng kÃ½ mÃ´n dáº¡y - GiÃ¡o viÃªn</title>
  <link rel="stylesheet" href="assets/css/global.css" />
  <link rel="stylesheet" href="assets/css/dashboard.css" />
  <style>
    .btn-group{display:flex;gap:8px;justify-content:flex-end}
    .btn-approve{background:#16a34a;color:#fff}
    .btn-approve:hover{filter:brightness(.95)}
    .btn-pending{background:#0ea5e9;color:#fff}
    .btn-pending[disabled]{opacity:.9;cursor:default}
    .btn-reject{background:#ef4444;color:#fff}
    .btn-reject:hover{filter:brightness(.95)}
    .btn-outline{background:transparent;border:1px solid #cbd5e1;color:#334155}

    .badge-approved{background:#dcfce7;color:#166534;padding:.25rem .5rem;border-radius:999px}
    .badge-active{background:#dbeafe;color:#1e3a8a;padding:.25rem .5rem;border-radius:999px}
    .badge-pending{background:#f1f5f9;color:#334155;padding:.25rem .5rem;border-radius:999px}

    td.actions{text-align:right}
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <h3>TMS</h3>
          <div class="small-muted">GiÃ¡o viÃªn</div>
        </div>
      </div>
      <nav class="nav">
  <a href="dashboard_teacher.html">ğŸ  Trang chá»§</a>
  <a href="register-subject_teacher.html">ğŸ“š ÄÄƒng kÃ½ mÃ´n</a>
  <a href="register-class_teacher.html">ğŸ—‚ï¸ ÄÄƒng kÃ½ lá»›p</a>
  <a href="report_teacher.html">ğŸ“„ BÃ¡o cÃ¡o</a>
  <a href="profile_teacher.html">ğŸ‘¤ Há»“ sÆ¡</a>
  <a href="login.html" id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</a>
</nav>
    </aside>

    <main class="main">
      <div class="header-row">
        <div>
          <div class="h1">ÄÄƒng kÃ½ mÃ´n giáº£ng dáº¡y</div>
          <div class="small-muted">Chá»n mÃ´n Ä‘á»ƒ gá»­i yÃªu cáº§u cáº¥p quyá»n (chá» admin duyá»‡t)</div>
        </div>
        <div class="search-filter">
          <input id="subjectSearch" class="input" placeholder="TÃ¬m mÃ´n theo mÃ£/tÃªn/khá»‘i..." />
          <button id="reloadBtn" class="btn">Táº£i láº¡i</button>
        </div>
      </div>

      <div class="card">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>MÃ£ mÃ´n</th>
              <th>TÃªn mÃ´n</th>
              <th>Khá»‘i</th>
              <th>Tráº¡ng thÃ¡i</th>
              <th style="width:220px;text-align:right">HÃ nh Ä‘á»™ng</th>
            </tr>
          </thead>
          <tbody id="subjectsTbody">
            <tr><td colspan="6">Äang táº£i...</td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Utils: fetchJSON/requireLoginOrRedirect/requireRoleOrRedirect/wireLogout -->
  <script src="assets/js/api.js"></script>
  <script>
    // ==== Endpoints (Ä‘á»•i náº¿u backend khÃ¡c route) ====
    const API_SUBJECTS     = '/api/subjects';                 // GET
    const API_PERMS_LIST   = '/api/teacher/permissions';      // GET
    const API_PERMS_CREATE = '/api/teacher/permissions';      // POST {subjectId}
    const API_PERMS_DELETE = id => `/api/teacher/permissions/${id}`; // DELETE

    document.addEventListener('DOMContentLoaded', initPage);

    async function initPage() {
      if (!requireLoginOrRedirect()) return;
      if (!requireRoleOrRedirect('TEACHER')) return;
      wireLogout('logoutBtn');

      const tbody  = document.getElementById('subjectsTbody');
      const inputQ = document.getElementById('subjectSearch');
      const btnReload = document.getElementById('reloadBtn');

      let SUBJECTS = [];
      let MYPERMS  = [];

      const fetchSubjects = () => fetchJSON(API_SUBJECTS);
      const fetchMyPerms  = async () => {
        try { return await fetchJSON(API_PERMS_LIST); }
        catch (e) { console.warn('permissions API error:', e.message); return []; }
      };
      const createPerm = subjectId =>
        fetchJSON(API_PERMS_CREATE, { method: 'POST', body: JSON.stringify({ subjectId }) });
      const deletePerm = permId =>
        fetchJSON(API_PERMS_DELETE(permId), { method: 'DELETE' });

      function indexPerms(perms) {
        const map = {};
        for (const p of perms || []) {
          const sid = (p?.subject?.id ?? p?.subjectId);
          if (sid != null) map[sid] = p;
        }
        return map;
      }

      function render() {
        const kw = (inputQ.value || '').toLowerCase();
        const list = (SUBJECTS || []).filter(s =>
          `${s.id} ${s.code||''} ${s.name||''} ${s.grade||''}`.toLowerCase().includes(kw)
        );

        tbody.innerHTML = '';
        if (!list.length) {
          tbody.innerHTML = `<tr><td colspan="6">KhÃ´ng cÃ³ dá»¯ liá»‡u</td></tr>`;
          return;
        }

        const bySid = indexPerms(MYPERMS);

        for (const s of list) {
          const p = bySid[s.id];

          let statusHtml = `<span class="badge badge-pending">ChÆ°a Ä‘Äƒng kÃ½</span>`;
          let actionHtml = `
            <div class="btn-group">
              <button class="btn btn-approve" data-act="register" data-sid="${s.id}">ÄÄƒng kÃ½</button>
            </div>`;

          if (p) {
            if (p.active) {
              statusHtml = `<span class="badge badge-approved">Äang hoáº¡t Ä‘á»™ng</span>`;
              actionHtml = `<div class="btn-group"><button class="btn btn-outline" disabled>ÄÃ£ cáº¥p quyá»n</button></div>`;
            } else {
              statusHtml = `<span class="badge badge-active">Chá» duyá»‡t</span>`;
              actionHtml = `
                <div class="btn-group">
                  <button class="btn btn-pending" disabled>ÄÃ£ gá»­i</button>
                  <button class="btn btn-reject" data-act="revoke" data-pid="${p.id}">Há»§y yÃªu cáº§u</button>
                </div>`;
            }
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${s.id}</td>
            <td>${s.code || ''}</td>
            <td>${s.name || ''}</td>
            <td>${s.grade || ''}</td>
            <td>${statusHtml}</td>
            <td class="actions">${actionHtml}</td>`;
          tbody.appendChild(tr);
        }
      }

      async function loadAll() {
        try {
          tbody.innerHTML = `<tr><td colspan="6">Äang táº£i...</td></tr>`;
          const [subs, perms] = await Promise.all([fetchSubjects(), fetchMyPerms()]);
          SUBJECTS = Array.isArray(subs) ? subs : [];
          MYPERMS  = Array.isArray(perms) ? perms : [];
          render();
        } catch (e) {
          console.error('Load error:', e);
          tbody.innerHTML = `<tr><td colspan="6">Lá»—i táº£i dá»¯ liá»‡u</td></tr>`;
          if (['UNAUTH','FORBIDDEN'].includes(String(e.message))) {
            alert('PhiÃªn Ä‘Äƒng nháº­p háº¿t háº¡n hoáº·c khÃ´ng Ä‘á»§ quyá»n.');
            localStorage.clear(); location.href='login.html';
          }
        }
      }

      document.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button[data-act]');
        if (!btn) return;
        try {
          if (btn.dataset.act === 'register') {
            await createPerm(+btn.dataset.sid);
            alert('ÄÃ£ gá»­i yÃªu cáº§u cáº¥p quyá»n mÃ´n. Vui lÃ²ng chá» admin duyá»‡t.');
            await loadAll();
          } else if (btn.dataset.act === 'revoke') {
            if (!confirm('Há»§y yÃªu cáº§u cho mÃ´n nÃ y?')) return;
            await deletePerm(+btn.dataset.pid);
            alert('ÄÃ£ há»§y yÃªu cáº§u.');
            await loadAll();
          }
        } catch (err) {
          console.error(err);
          alert(err.message || 'CÃ³ lá»—i xáº£y ra.');
        }
      });

      inputQ.addEventListener('input', render);
      btnReload.addEventListener('click', loadAll);

      await loadAll();
    }
  </script>
</body>
</html>
