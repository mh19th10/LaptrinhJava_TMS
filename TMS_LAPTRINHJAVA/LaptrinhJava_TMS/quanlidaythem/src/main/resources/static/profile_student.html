<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Há»“ sÆ¡ - Há»c sinh</title>
  <link rel="stylesheet" href="assets/css/global.css" />
  <link rel="stylesheet" href="assets/css/dashboard.css" />
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="brand"><div class="logo">T</div><div><h3>TMS</h3><div class="small-muted">Há»c sinh</div></div></div>
      <nav class="nav">
        <a href="dashboard_student.html">ğŸ  Trang chá»§</a>
        <a href="classes_student.html">ğŸ“š Lá»›p há»c</a>
        <a href="tuition_student.html">ğŸ’° Há»c phÃ­</a>
        <a href="profile_student.html" class="active">ğŸ‘¤ Há»“ sÆ¡</a>
        <a href="#" id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</a>
      </nav>
    </aside>

    <main class="main">
      <div class="header-row">
        <div>
          <div class="h1">ThÃ´ng tin cÃ¡ nhÃ¢n</div>
          <div class="small-muted">Báº¡n cÃ³ thá»ƒ cáº­p nháº­t thÃ´ng tin há»“ sÆ¡ táº¡i Ä‘Ã¢y</div>
        </div>
      </div>

      <div class="card">
        <!-- Form Há»’ SÆ  (form duy nháº¥t trÃªn trang) -->
        <form id="profileForm" class="row" style="flex-direction:column;gap:12px">
          <div style="width:100%">
            <label class="small-muted">Há» vÃ  tÃªn</label>
            <input id="fullName" class="input" type="text" placeholder="Äang táº£i..." />
          </div>
          <div style="width:100%">
            <label class="small-muted">Username (KhÃ´ng thá»ƒ Ä‘á»•i)</label>
            <input id="username" class="input" type="text" readonly disabled />
          </div>
          <div style="width:100%">
            <label class="small-muted">Lá»›p hiá»‡n táº¡i</label>
            <input id="currentClass" class="input" type="text" placeholder="Äang táº£i..." />
          </div>

          <div style="margin-top:6px">
            <button type="submit" class="btn">Cáº­p nháº­t</button>
          </div>

          <div id="statusMessage" style="margin-top:10px;"></div>
        </form>
      </div>

      <!-- Khá»‘i Äá»”I Máº¬T KHáº¨U (KHÃ”NG pháº£i form Ä‘á»ƒ trÃ¡nh lá»“ng form) -->
      <div class="card" style="margin-top:16px">
        <div class="h2">Äá»•i máº­t kháº©u</div>
        <div id="changePwdBox" style="display:grid;gap:12px;max-width:520px">
          <input class="input" type="password" id="oldPassword" placeholder="Máº­t kháº©u hiá»‡n táº¡i" required />
          <input class="input" type="password" id="newPassword" placeholder="Máº­t kháº©u má»›i" required />
          <input class="input" type="password" id="confirmPassword" placeholder="Nháº­p láº¡i máº­t kháº©u má»›i" required />
          <button id="btnChangePwd" type="button" class="btn">Cáº­p nháº­t máº­t kháº©u</button>
        </div>
      </div>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('jwtToken');
    const role  = (localStorage.getItem('userRole') || '').toUpperCase();

    // Guard: token + Ä‘Ãºng role
    if (!token) { alert('Báº¡n cáº§n Ä‘Äƒng nháº­p!'); location.href='login.html'; return; }
    if (role !== 'STUDENT') { location.href = (role==='TEACHER'?'profile_teacher.html':'login.html'); return; }

    const profileForm = document.getElementById('profileForm');
    const fullNameInput = document.getElementById('fullName');
    const usernameInput = document.getElementById('username');
    const currentClassInput = document.getElementById('currentClass');
    const statusMessage = document.getElementById('statusMessage');

    async function loadUserProfile() {
      try {
        const res = await fetch('/api/student/profile', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.status === 401) throw new Error('UNAUTH');
        if (res.status === 403) throw new Error('FORBIDDEN');
        if (!res.ok) throw new Error('OTHER');
        const data = await res.json();

        fullNameInput.value = data.fullName || '';
        usernameInput.value = data.username || '';
        currentClassInput.value = data.currentClass || 'ChÆ°a cÃ³ lá»›p';
      } catch (e) {
        if (e.message === 'UNAUTH') {
          alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
        } else if (e.message === 'FORBIDDEN') {
          alert('Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p trang nÃ y.');
        } else {
          alert('KhÃ´ng thá»ƒ táº£i há»“ sÆ¡.');
        }
        localStorage.clear(); location.href = 'login.html';
      }
    }

    profileForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      statusMessage.textContent = 'Äang cáº­p nháº­t...'; statusMessage.style.color = 'black';

      const body = {
        fullName: fullNameInput.value,
        currentClass: currentClassInput.value
      };

      try {
        const res = await fetch('/api/student/profile', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify(body)
        });
        if (res.status === 401) throw new Error('UNAUTH');
        if (res.status === 403) throw new Error('FORBIDDEN');
        if (!res.ok) throw new Error(await res.text() || 'OTHER');
        statusMessage.textContent = 'Cáº­p nháº­t há»“ sÆ¡ thÃ nh cÃ´ng!'; statusMessage.style.color = 'green';
      } catch (e) {
        statusMessage.textContent = (e.message==='UNAUTH'?'PhiÃªn háº¿t háº¡n':
                                     e.message==='FORBIDDEN'?'Sai quyá»n':('Lá»—i: '+e.message));
        statusMessage.style.color = 'red';
        if (e.message==='UNAUTH' || e.message==='FORBIDDEN') { localStorage.clear(); location.href='login.html'; }
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault(); localStorage.clear(); location.href='login.html';
    });

    // ğŸ‘‰ Handler Äá»”I Máº¬T KHáº¨U (khÃ´ng submit form)
    const btnChangePwd = document.getElementById('btnChangePwd');
    btnChangePwd.addEventListener('click', async (e) => {
      e.preventDefault();
      const oldPassword = (document.getElementById('oldPassword')?.value || '').trim();
      const newPassword = (document.getElementById('newPassword')?.value || '').trim();
      const confirmPassword = (document.getElementById('confirmPassword')?.value || '').trim();

      if (!oldPassword || !newPassword || !confirmPassword) {
        alert('Vui lÃ²ng nháº­p Ä‘á»§ 3 Ã´ máº­t kháº©u.'); return;
      }
      if (newPassword !== confirmPassword) {
        alert('XÃ¡c nháº­n máº­t kháº©u khÃ´ng khá»›p.'); return;
      }
      try {
        const res = await fetch('/api/account/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ oldPassword, newPassword, confirmPassword })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          alert(data.message || 'Äá»•i máº­t kháº©u tháº¥t báº¡i.'); return;
        }
        alert(data.message || 'Äá»•i máº­t kháº©u thÃ nh cÃ´ng! Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
        localStorage.clear(); location.href = 'login.html';
      } catch (err) {
        console.error(err); alert('CÃ³ lá»—i máº¡ng khi Ä‘á»•i máº­t kháº©u.');
      }
    });

    // Load há»“ sÆ¡ láº§n Ä‘áº§u
    loadUserProfile();
  });
  </script>
</body>
</html>
