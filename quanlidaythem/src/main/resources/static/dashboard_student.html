<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TMS - Dashboard (Há»c sinh)</title>
  <link rel="stylesheet" href="assets/css/global.css" />
  <link rel="stylesheet" href="assets/css/dashboard.css" />
</head>
<body>
  <div class="app-container" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <h3>TMS</h3>
          <div class="small-muted">Há»c sinh</div>
        </div>
      </div>

      <nav class="nav">
        <a href="dashboard_student.html" class="active">ğŸ  Trang chá»§</a>
        <a href="classes_student.html">ğŸ“š Lá»›p há»c</a>
        <a href="tuition_student.html">ğŸ’° Há»c phÃ­</a>
        <a href="profile_student.html">ğŸ‘¤ Há»“ sÆ¡</a>
        <a href="#" id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="header-row">
        <div>
          <div class="h1" id="studentName">Äang táº£i...</div>
          <div class="small-muted">ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i há»‡ thá»‘ng TMS</div>
        </div>
      </div>

      <div class="cards" id="studentStats"><!-- Dá»¯ liá»‡u thá»‘ng kÃª sáº½ Ä‘Æ°á»£c render á»Ÿ Ä‘Ã¢y --></div>

      <div class="card">
        <div class="h2">Lá»›p há»c sáº¯p diá»…n ra</div>
        <table class="table" style="margin-top:12px">
          <thead>
            <tr><th>Lá»›p</th><th>GiÃ¡o viÃªn</th><th>Thá»i gian</th><th>HÃ nh Ä‘á»™ng</th></tr>
          </thead>
          <tbody id="upcomingClasses"><!-- Dá»¯ liá»‡u lá»›p há»c sáº½ Ä‘Æ°á»£c render á»Ÿ Ä‘Ã¢y --></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // FIX 1: Sá»­ dá»¥ng Ä‘Ãºng tÃªn 'jwtToken' Ä‘Ã£ lÆ°u khi Ä‘Äƒng nháº­p
    const token = localStorage.getItem('jwtToken');

    // Gatekeeper: Kiá»ƒm tra náº¿u ngÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p
    if (!token) {
      alert('Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ truy cáº­p trang nÃ y!');
      window.location.href = 'login.html';
      return;
    }

    // Láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng tá»« API Ä‘Æ°á»£c báº£o vá»‡
    // FIX 2: Sá»­ dá»¥ng Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i
    fetch('/api/student/info', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    })
    .then(response => {
      if (response.status === 401 || response.status === 403) {
        // Náº¿u token khÃ´ng há»£p lá»‡ hoáº·c háº¿t háº¡n, nÃ©m lá»—i Ä‘á»ƒ nháº£y vÃ o .catch()
        throw new Error('Token khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n.');
      }
      if (!response.ok) {
        throw new Error('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u ngÆ°á»i dÃ¹ng.');
      }
      return response.json();
    })
    .then(data => {
      // FIX 3: Sá»­ dá»¥ng Ä‘Ãºng trÆ°á»ng `fullName` tá»« backend
      document.getElementById('studentName').textContent = 'ChÃ o, ' + (data.fullName || 'Há»c sinh');
      
      // TODO: Gá»i cÃ¡c hÃ m khÃ¡c Ä‘á»ƒ táº£i dá»¯ liá»‡u thá»‘ng kÃª vÃ  lá»›p há»c...
      // fetchStudentStats(token);
      // fetchUpcomingClasses(token);
    })
    .catch(error => {
      console.error('Lá»—i xÃ¡c thá»±c:', error.message);
      alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
      
      // Dá»n dáº¹p vÃ  chuyá»ƒn hÆ°á»›ng
      localStorage.clear();
      window.location.href = 'login.html';
    });

    // Xá»­ lÃ½ sá»± kiá»‡n Ä‘Äƒng xuáº¥t
    document.getElementById('logoutBtn').addEventListener('click', (event) => {
      event.preventDefault(); // NgÄƒn hÃ nh vi máº·c Ä‘á»‹nh cá»§a tháº» <a>
      
      console.log('ÄÄƒng xuáº¥t...');
      localStorage.clear(); // XÃ³a toÃ n bá»™ dá»¯ liá»‡u trong localStorage
      window.location.href = 'login.html';
    });
  });
  </script>
</body>
</html>
