<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Hồ sơ - Giáo viên</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/dashboard.css">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <h3>TMS</h3>
          <div class="small-muted">Giáo viên</div>
        </div>
      </div>
      <nav class="nav">
        <a href="dashboard_teacher.html">🏠 Trang chủ</a>
        <a href="register-class_teacher.html">📚 Đăng ký lớp</a>
        <a href="report_teacher.html">📄 Báo cáo</a>
        <a href="profile_teacher.html" class="active">👤 Hồ sơ</a>
        <a href="login.html" id="logoutBtn">🚪 Đăng xuất</a>
      </nav>
    </aside>

    <main class="main">
      <div class="header-row">
        <div class="h1">Hồ sơ cá nhân</div>
        <div class="small-muted">Cập nhật thông tin cá nhân của bạn</div>
      </div>

      <div class="card">
        <!-- Form HỒ SƠ -->
        <form id="teacherProfileForm" style="display:grid;gap:12px;max-width:640px">
          <div>
            <label class="small-muted">Họ và tên</label>
            <input id="t_fullName" class="input" type="text" placeholder="Đang tải..." />
          </div>
          <div>
            <label class="small-muted">Email (username)</label>
            <input id="t_username" class="input" type="email" readonly disabled />
          </div>
          <div>
            <label class="small-muted">Môn giảng dạy chính</label>
            <input id="t_mainSubject" class="input" type="text" placeholder="VD: Toán học" />
          </div>
          <div>
            <label class="small-muted">Số điện thoại</label>
            <input id="t_phone" class="input" type="tel" placeholder="VD: 0901234567" />
          </div>
          <button class="btn">Cập nhật</button>
          <div id="t_status" style="margin-top:10px;"></div>
        </form>
      </div>

      <!-- Khối ĐỔI MẬT KHẨU (KHÔNG phải form để tránh lồng form) -->
      <div class="card" style="margin-top:16px">
        <div class="h2">Đổi mật khẩu</div>
        <div id="changePwdBox" style="display:grid;gap:12px;max-width:520px">
          <input class="input" type="password" id="oldPassword" placeholder="Mật khẩu hiện tại" required />
          <input class="input" type="password" id="newPassword" placeholder="Mật khẩu mới" required />
          <input class="input" type="password" id="confirmPassword" placeholder="Nhập lại mật khẩu mới" required />
          <button id="btnChangePwd" type="button" class="btn">Cập nhật mật khẩu</button>
        </div>
      </div>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('jwtToken');
    const role  = (localStorage.getItem('userRole') || '').toUpperCase();
    if (!token) { alert('Bạn cần đăng nhập!'); location.href='login.html'; return; }
    if (role !== 'TEACHER') { location.href = (role==='STUDENT'?'profile_student.html':'login.html'); return; }

    const form = document.getElementById('teacherProfileForm');
    const fullName = document.getElementById('t_fullName');
    const username = document.getElementById('t_username');
    const mainSubject = document.getElementById('t_mainSubject');
    const phone = document.getElementById('t_phone');
    const status = document.getElementById('t_status');

    async function loadProfile() {
      try {
        const res = await fetch('/api/teacher/profile', {
          headers: { 'Authorization':'Bearer '+token }
        });
        if (res.status===401) throw new Error('UNAUTH');
        if (res.status===403) throw new Error('FORBIDDEN');
        if (!res.ok) throw new Error('OTHER');
        const data = await res.json();
        fullName.value = data.fullName || '';
        username.value = data.username || '';
        mainSubject.value = data.mainSubject || '';
        phone.value = data.phone || '';
      } catch (e) {
        alert(e.message==='FORBIDDEN'?'Bạn không có quyền':'Phiên hết hạn / lỗi tải hồ sơ');
        localStorage.clear(); location.href='login.html';
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      status.textContent = 'Đang cập nhật...'; status.style.color = 'black';
      const body = {
        fullName: fullName.value,
        mainSubject: mainSubject.value,
        phone: phone.value
      };
      try {
        const res = await fetch('/api/teacher/profile', {
          method: 'PUT',
          headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
          body: JSON.stringify(body)
        });
        if (res.status===401) throw new Error('UNAUTH');
        if (res.status===403) throw new Error('FORBIDDEN');
        if (!res.ok) throw new Error(await res.text()||'OTHER');
        status.textContent = 'Cập nhật thành công!'; status.style.color = 'green';
      } catch (e) {
        status.textContent = (e.message==='FORBIDDEN'?'Sai quyền': e.message==='UNAUTH'?'Phiên hết hạn':'Lỗi: '+e.message);
        status.style.color = 'red';
        if (e.message==='UNAUTH' || e.message==='FORBIDDEN') { localStorage.clear(); location.href='login.html'; }
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault(); localStorage.clear(); location.href='login.html';
    });

    // 👉 Handler ĐỔI MẬT KHẨU (không submit form)
    const btnChangePwd = document.getElementById('btnChangePwd');
    btnChangePwd.addEventListener('click', async (e) => {
      e.preventDefault();
      const oldPassword = (document.getElementById('oldPassword')?.value || '').trim();
      const newPassword = (document.getElementById('newPassword')?.value || '').trim();
      const confirmPassword = (document.getElementById('confirmPassword')?.value || '').trim();

      if (!oldPassword || !newPassword || !confirmPassword) {
        alert('Vui lòng nhập đủ 3 ô mật khẩu.'); return;
      }
      if (newPassword !== confirmPassword) {
        alert('Xác nhận mật khẩu không khớp.'); return;
      }
      try {
        const res = await fetch('/api/account/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ oldPassword, newPassword, confirmPassword })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          alert(data.message || 'Đổi mật khẩu thất bại.'); return;
        }
        alert(data.message || 'Đổi mật khẩu thành công! Vui lòng đăng nhập lại.');
        localStorage.clear(); location.href = 'login.html';
      } catch (err) {
        console.error(err); alert('Có lỗi mạng khi đổi mật khẩu.');
      }
    });

    // Load hồ sơ lần đầu
    loadProfile();
  });
  </script>
</body>
</html>
