<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Há»“ sÆ¡ - GiÃ¡o viÃªn</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/dashboard.css">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <h3>TMS</h3>
          <div class="small-muted">GiÃ¡o viÃªn</div>
        </div>
      </div>
      <nav class="nav">
        <a href="dashboard_teacher.html">ğŸ  Trang chá»§</a>
        <a href="register-class_teacher.html">ğŸ“š ÄÄƒng kÃ½ lá»›p</a>
        <a href="report_teacher.html">ğŸ“„ BÃ¡o cÃ¡o</a>
        <a href="profile_teacher.html" class="active">ğŸ‘¤ Há»“ sÆ¡</a>
        <a href="login.html" id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</a>
      </nav>
    </aside>

    <main class="main">
      <div class="header-row">
        <div class="h1">Há»“ sÆ¡ cÃ¡ nhÃ¢n</div>
        <div class="small-muted">Cáº­p nháº­t thÃ´ng tin cÃ¡ nhÃ¢n cá»§a báº¡n</div>
      </div>

      <div class="card">
        <!-- Form Há»’ SÆ  -->
        <form id="teacherProfileForm" style="display:grid;gap:12px;max-width:640px">
          <div>
            <label class="small-muted">Há» vÃ  tÃªn</label>
            <input id="t_fullName" class="input" type="text" placeholder="Äang táº£i..." />
          </div>
          <div>
            <label class="small-muted">Email (username)</label>
            <input id="t_username" class="input" type="email" readonly disabled />
          </div>
          <div>
            <label class="small-muted">MÃ´n giáº£ng dáº¡y chÃ­nh</label>
            <input id="t_mainSubject" class="input" type="text" placeholder="VD: ToÃ¡n há»c" />
          </div>
          <div>
            <label class="small-muted">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
            <input id="t_phone" class="input" type="tel" placeholder="VD: 0901234567" />
          </div>
          <button class="btn">Cáº­p nháº­t</button>
          <div id="t_status" style="margin-top:10px;"></div>
        </form>
      </div>

      <!-- Khá»‘i Äá»”I Máº¬T KHáº¨U (KHÃ”NG pháº£i form Ä‘á»ƒ trÃ¡nh lá»“ng form) -->
      <div class="card" style="margin-top:16px">
        <div class="h2">Äá»•i máº­t kháº©u</div>
        <div id="changePwdBox" style="display:grid;gap:12px;max-width:520px">
          <input class="input" type="password" id="oldPassword" placeholder="Máº­t kháº©u hiá»‡n táº¡i" required />
          <input class="input" type="password" id="newPassword" placeholder="Máº­t kháº©u má»›i" required />
          <input class="input" type="password" id="confirmPassword" placeholder="Nháº­p láº¡i máº­t kháº©u má»›i" required />
          <button id="btnChangePwd" type="button" class="btn">Cáº­p nháº­t máº­t kháº©u</button>
        </div>
      </div>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('jwtToken');
    const role  = (localStorage.getItem('userRole') || '').toUpperCase();
    if (!token) { alert('Báº¡n cáº§n Ä‘Äƒng nháº­p!'); location.href='login.html'; return; }
    if (role !== 'TEACHER') { location.href = (role==='STUDENT'?'profile_student.html':'login.html'); return; }

    const form = document.getElementById('teacherProfileForm');
    const fullName = document.getElementById('t_fullName');
    const username = document.getElementById('t_username');
    const mainSubject = document.getElementById('t_mainSubject');
    const phone = document.getElementById('t_phone');
    const status = document.getElementById('t_status');

    async function loadProfile() {
      try {
        const res = await fetch('/api/teacher/profile', {
          headers: { 'Authorization':'Bearer '+token }
        });
        if (res.status===401) throw new Error('UNAUTH');
        if (res.status===403) throw new Error('FORBIDDEN');
        if (!res.ok) throw new Error('OTHER');
        const data = await res.json();
        fullName.value = data.fullName || '';
        username.value = data.username || '';
        mainSubject.value = data.mainSubject || '';
        phone.value = data.phone || '';
      } catch (e) {
        alert(e.message==='FORBIDDEN'?'Báº¡n khÃ´ng cÃ³ quyá»n':'PhiÃªn háº¿t háº¡n / lá»—i táº£i há»“ sÆ¡');
        localStorage.clear(); location.href='login.html';
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      status.textContent = 'Äang cáº­p nháº­t...'; status.style.color = 'black';
      const body = {
        fullName: fullName.value,
        mainSubject: mainSubject.value,
        phone: phone.value
      };
      try {
        const res = await fetch('/api/teacher/profile', {
          method: 'PUT',
          headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
          body: JSON.stringify(body)
        });
        if (res.status===401) throw new Error('UNAUTH');
        if (res.status===403) throw new Error('FORBIDDEN');
        if (!res.ok) throw new Error(await res.text()||'OTHER');
        status.textContent = 'Cáº­p nháº­t thÃ nh cÃ´ng!'; status.style.color = 'green';
      } catch (e) {
        status.textContent = (e.message==='FORBIDDEN'?'Sai quyá»n': e.message==='UNAUTH'?'PhiÃªn háº¿t háº¡n':'Lá»—i: '+e.message);
        status.style.color = 'red';
        if (e.message==='UNAUTH' || e.message==='FORBIDDEN') { localStorage.clear(); location.href='login.html'; }
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault(); localStorage.clear(); location.href='login.html';
    });

    // ğŸ‘‰ Handler Äá»”I Máº¬T KHáº¨U (khÃ´ng submit form)
    const btnChangePwd = document.getElementById('btnChangePwd');
    btnChangePwd.addEventListener('click', async (e) => {
      e.preventDefault();
      const oldPassword = (document.getElementById('oldPassword')?.value || '').trim();
      const newPassword = (document.getElementById('newPassword')?.value || '').trim();
      const confirmPassword = (document.getElementById('confirmPassword')?.value || '').trim();

      if (!oldPassword || !newPassword || !confirmPassword) {
        alert('Vui lÃ²ng nháº­p Ä‘á»§ 3 Ã´ máº­t kháº©u.'); return;
      }
      if (newPassword !== confirmPassword) {
        alert('XÃ¡c nháº­n máº­t kháº©u khÃ´ng khá»›p.'); return;
      }
      try {
        const res = await fetch('/api/account/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ oldPassword, newPassword, confirmPassword })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          alert(data.message || 'Äá»•i máº­t kháº©u tháº¥t báº¡i.'); return;
        }
        alert(data.message || 'Äá»•i máº­t kháº©u thÃ nh cÃ´ng! Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
        localStorage.clear(); location.href = 'login.html';
      } catch (err) {
        console.error(err); alert('CÃ³ lá»—i máº¡ng khi Ä‘á»•i máº­t kháº©u.');
      }
    });

    // Load há»“ sÆ¡ láº§n Ä‘áº§u
    loadProfile();
  });
  </script>
</body>
</html>
